# چرا دسترسی پذیری بالا (High Availability) در PostgreSQL اهمیت دارد

**پشت‌صحنه سرویس‌دهی بی‌وقفه: چگونه استولون (Stolon) تضمین می‌کند PostgreSQL هرگز از کار نیفتد**

PostgreSQL یک سیستم پایگاه‌داده آبجکت-رابطه‌ای (object-relational) قدرتمند و متن‌باز است که به دلیل قابلیت اطمینان بالا، امکانات گسترده و انعطاف‌پذیری چشمگیر شناخته می‌شود. این پایگاه‌داده برای طیف وسیعی از کاربردها، از پروژه‌های کوچک گرفته تا سیستم‌ها سازمانی در مقیاس بزرگ، مناسب است و از کوئری‌های SQL (رابطه‌ای) و JSON (غیررابطه‌ای) پشتیبانی می‌کند. اما یک خرابی پایگاه داده می‌تواند به خسارت‌های جبران ناپذیر و از دست دادن اعتماد کاربران منجر شود. سیستم‌های دسترسی پذیری بالا (HA) مانند استولون (Stolon) اکنون قول ازکارافتادگی نزدیک به صفر درصد را می‌دهند و خرابی‌های برگشت‌ناپذیر را تبدیل به نگرانی‌ای برای مردمان گذشته می‌کنند.

تصور کنید طی یک رویداد فروش آنلاین عظیم، سرور اصلی PostgreSQL یک خرده‌فروش جهانی از کار بیفتد. استولون (Stolon) ظرف چند ثانیه (گاه تا ۵ ثانیه بسته به معماری) خرابی را تشخیص داده، یک سرور آماده به کار را به سرور اصلی ارتقا می‌دهد و ترافیک مشتریان را هدایت می‌کند و از هرگونه قطعی قابل‌توجه یا ضرر درآمدی جلوگیری به عمل می‌آورد. این شانس نیست، بلکه طراحی و معماری است؛ تا سال ۲۰۲۴، هیچ مشکل مهمی در محیط پروداکشن (Production Environment) اپلیکیشن‌های استفاده کننده از استولون (Stolon) گزارش نشده و تست‌های تاب‌آوری با موفقیت انجام شده‌اند.

دسترسی پذیری بالا (HA) ستون فقرات استقرارهای مقاوم دربرابر مشکل PostgreSQL است. برخلاف بازیابی پس از فاجعه (که بر بازگشت پس از خرابی تمرکز دارد) دسترسی پذیری بالا (HA) درباره پایداری در هر شرایطی است. کسب‌وکارها توافق‌نامه‌های سطح خدمات (SLAs) سختگیرانه‌ای می‌خواهند : زمان بازیابی در حد ثانیه و از دست دادن هیچگونه داده‌ای (استولون (Stolon) هدف‌گذاری سطح خدمات (SLO) با دسترسی ۹۹٫۹۹۹٪، معادل حداکثر ۵٫۵ و حتی قابل کاهش به ۳٫۱ دقیقه قطعی در سال را ارائه می‌دهد)؛ استولون (Stolon)، یک مدیریت‌‌کننده دسترسی پذیری بالا (HA) کلاود نیتیو (cloud native) برای PostgreSQL، این وعده‌ها را با ساده‌سازی ارکستراسیون (orchestration) پیچیده و خودکارسازی تغییر مسیرها (failovers) با سرعت و دقت برآورده می‌کند.

---

## ظهور دسترسی پذیری بالا در PostgreSQL

PostgreSQL به عنوان یک پایگاه داده تک‌نود (single-node) با گزینه‌های محدود تکثیر (replication) شروع شد. استراتژی‌های اولیه دسترسی پذیری بالا (HA) دستی، کند و مستعد خطا بودند.

- **پیش از 2010:** تغییر مسیر (failover) دستی و تکثیر (replication) ساده.
- **2010–2018:** معرفی ابزارهایی مانند پی‌جی‌پول (Pgpool) و پاترونی (Patroni)، خودکارسازی تغییر مسیر (failover) و تعادل بار کاری (load balancing).
- **2019–اکنون:** ابزارهای کلاود نیتیو (cloud native) مانند استولون (Stolon) دسترسی پذیری بالا (HA) را به کوبرنتیز (Kubernetes)، محیط‌های کانتینری و زیرساخت‌های مدرن آورده‌اند.

این تکامل نشان‌دهنده تغییر گسترده به سمت سیستم‌های با هیچگونه از کار افتادگی و دسترسی پذیری بالا در برنامه‌های حیاتی است.

---

## چگونه دسترسی پذیری بالا در PostgreSQL امروز شکل می‌گیرد

چهار معماری اصلی دسترسی پذیری بالا (HA) بر استقرارهای PostgreSQL غالب هستند:

- **تک سرور اصلی (Single Primary) با چند استندبای (Standbys):** تکثیر (replication) جریانی با تغییر مسیر (failover) خودکار (به کار رفته در استولون (Stolon)، پاترونی (Patroni)).
- **تک سرور اصلی (Single Primary) با رپلیکاهای خواندنی (Read Replicas):** استفاده در سرور خواندنی مقیاس‌بزرگ (Read scaling) به علاوه تغییر مسیر (failover)؛ مدیریت‌شده توسط پی‌جی‌پول (Pgpool) یا اچ‌ای‌پروکسی (HAProxy).
- **چند نود مستر (Multi-Master) با هماهنگ‌کننده (Coordinator):** خوشه‌های تقسیم‌شده مانند سیتوس (Citus) که مقیاس‌پذیری نوشتن را ارائه می‌دهند.
- **چند مستری توزیع‌شده (Distributed Multi-Master):** یوگابایت‌دی‌بی (YugabyteDB) و پایگاه‌های داده مشابه که اجماع مبتنی بر رافت (Raft) را بدون هماهنگ‌کننده فراهم می‌کنند.

استولون (Stolon) در دو دسته اول قرار دارد و به دلیل یکپارچگی با کوبرنتیز (Kubernetes) و تغییر مسیر خودکار (automated failover) ارزشمند است.

---

## چگونه استولون (Stolon) کار می‌کند: رهبر خوشه‌های PostgreSQL

یک سمفونی که هر نوازنده به طور کامل در هماهنگی می‌نوازد را تصور کنید؛ استولون (Stolon) هر نمونه موجودیت (instance) PostgreSQL را از طریق سه جزء کلیدی هدایت می‌کند:

- **نگهدارنده (Keeper):** نمونه موجودیت‌های (instance) PostgreSQL را اجرا و تکثیر (replication) را مدیریت می‌کند.
- **ناظر (Sentinel):** سلامت خوشه (cluster) را نظارت می‌کند، سرور اصلی (primary) را انتخاب و تغییر مسیر را در چند ثانیه فعال می‌کند.
- **پروکسی (Proxy):** اتصالات مشتریان را به سرور اصلی فعلی هدایت می‌کند و در طول تغییر مسیر، اتصالات قدیمی را به آرامی می‌بندد.

یک مخزن پیکربندی توزیع‌شده (distributed configuration store) مانند ات‌سی‌دی (etcd)، کنسول (Consul)، یا API کوبرنتیس (Kubernetes)، از پایداری خوشه (cluster state consistency) و انتخاب رهبر (leader) مطمئن می‌شود و از بوجود آمدن تک نقاط آسیب‌پذیر مرکزی (single points of failure) جلوگیری می‌کند.

---

### جزئیات فنی

- **حالت‌های تکثیر (Replication Modes):** از تکثیر جریانی ناهمزمان (async) و همزمان (sync) پشتیبانی می‌کند. تنظیم synchronous_commit می‌تواند به `on` یا `remote_apply` تنظیم شود تا از جلوگیری از دست دادن داده (zero data loss) تضمین شود (RPO=0).
- **زمان‌بندی تغییر مسیر (failover):** تغییر مسیر خودکار معمولاً در چند ثانیه کامل می‌شود، قابل تنظیم تا 3-5 ثانیه.
- **آماده برای کلاود:** پشتیبانی بومی از کوبرنتیس (Kubernetes) از طریق چارت‌های هلم (Helm charts) و استیت‌فول‌ست‌ها (StatefulSets) امکان مقیاس‌بندی و استقرار پویا (dynamic scaling and deployment) را فراهم می‌کند.
- **مدیریت:** ابزار خط فرمان `stolonctl` نظارت، پیکربندی و به‌روزرسانی خوشه را با هیچگونه قطعی (zero downtime) ممکن می‌سازد.

---

## چالش‌ها و محدودیت‌ها

هیچ راه‌حلی بدون نقص نیست:

- **پیکربندی پیچیده:** تنظیم نگهدارنده‌ها (keepers)، مراقبان (sentinels)، پروکسی‌ها (proxies) و مخازن توزیع‌شده نیاز به تخصص و زیرساخت دارد.
- **وابستگی‌های خارجی:** به ات‌سی‌دی (etcd)، کنسول (Consul) یا API کوبرنتیس (Kubernetes) برای حالت خوشه (cluster state) نیاز دارد که بار عملیاتی را افزایش می‌دهد.
- **مستندات محدود:** منابع پیشرفته محدود، عیب‌یابی را برای مبتدیان دشوار می‌کند.
- **معماری متمرکز:** برای دسترسی پذیری بالا (HA) تک‌ سرور اصلی (single-primary) بهینه شده است، نه برای سناریوهای اشتراکی یا چند مستر (multi-master).
- **توسعه کندتر:** جامعه کوچک‌تر و به‌روزرسانی‌های کمتر در مقایسه با پاترونی (Patroni) یا اپراتور کرونچی‌دیتا (CrunchyData).
- **عدم نظارت/پشتیبان‌گیری یکپارچه:** نیاز به ابزارهای خارجی برای بازیابی در یک نقطه زمانی خاص (PITR) و مشاهده‌پذیری (observability) و نظارت دارد.

---

## مقایسه استولون (Stolon) با گزینه‌های دیگر

| ویژگی                                       | استولون (Stolon)                                   | پاترونی (Patroni)                                    | کرونچی‌دیتا (CrunchyData)                                          | رپ‌مگر (repmgr)                                           |
| ------------------------------------------- | -------------------------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------------ | --------------------------------------------------------- |
| تمرکز مرکزیت (Primary Focus)                | دسترسی پذیری بالا (HA) تک سرور اصلی، بومی کوبرنتیز | دسترسی پذیری بالا (HA) تک سرو اصلی و همچنین چند مستر | اپراتور کامل PostgreSQL (دسترسی پذیری بالا + پشتیبان‌گیری + نظارت) | تکثیر و تغییر مسیر پایه‌ای (Basic replication & failover) |
| خودکارسازی تغییر مسیر (Failover Automation) | بله، حدود ۵ ثانیه                                  | بله، بسیار قابل تنظیم                                | بله، با ابزارهای پیشرفته                                           | نیمه‌خودکار/دستی                                          |
| پروکسی یکپارچه                              | بله                                                | خیر (نیاز به HAProxy یا گزینه‌های دیگر)              | بله                                                                | خیر                                                       |
| فعالیت کامیونیتی                            | متوسط                                              | بالا                                                 | بالا                                                               | پایین                                                     |
| مستندات                                     | محدود                                              | گسترده                                               | گسترده                                                             | متوسط                                                     |
| پشتیبانی از چند مستر (multi-master)         | خیر                                                | بله                                                  | جزئی                                                               | خیر                                                       |
| یکپارچگی با کوبرنتیز                        | بومی                                               | بومی                                                 | بومی                                                               | محدود                                                     |

استولون (Stolon) برای تیم‌های کوبرنتیز که به دنبال راه‌حل دسترسی پذیری بالا (HA) ساده با پروکسی‌های یکپارچه هستند، ایده‌آل است. پاترونی (Patroni) انعطاف‌پذیری گسترده‌تر و جامعه بزرگ‌تری ارائه می‌دهد. کرونچی‌دیتا (CrunchyData) یک اپراتور کامل مناسب برای شرکت‌هایی است که نیاز به مدیریت کامل دارند. رپ‌مگر (repmgr) برای تنظیمات ساده‌تر و کوچک‌تر مناسب است.

---

## آینده دسترسی پذیری بالا در PostgreSQL

آینده دسترسی پذیری بالا (HA) PostgreSQL در خودکارسازی دقیق‌تر و تغییر مسیر هوشمندتر نهفته است:

- ترکیب با هوش مصنوعی برای تشخیص ناهنجاری‌ها و پیش‌بینی تغییر مسیر (predictive failover).
- بهبود مشاهده‌پذیری و خودترمیمی فراتر از تغییر مسیر (failover).
- پشتیبانی پیشرفته چندمنطقه‌ای (multi-region) و چندمستر (multi-master) برای پاسخگویی به نیازها در مقیاس جهانی.

طراحی کلاود نیتیو (cloud native) استولون (Stolon) آن را با این مسیر هم‌راستا می‌کند، اما اکوسیستم در حال تحول به سازگاری سریع‌تر، مستندات بهتر و مجموعه ویژگی‌های گسترده‌تر نیاز دارد.

---

**وقتی دسترسی پذیری داده‌ها به معنای حفظ کسب و کار شما است، سؤال این نیست که آیا خرابی رخ می‌دهد؛ بلکه این است که آیا ابزارهای دسترسی پذیری بالا (HA) شما می‌توانند به اندازه کافی سریع آن را مدیریت کنند. با استولون (Stolon)، PostgreSQL برای این چالش آماده است.**
