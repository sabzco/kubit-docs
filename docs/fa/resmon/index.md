# ریسمان (رصد منابع)

## تعاریف موجود در این سند

- زیربخش‌های یک کلاستر : شامل نود، فضانام، ورک‌لود، پاد و کانتینر است.
- انوع منابع : پردازنده، حافظه، دیسک (شامل دو نوع ssd و hdd)
- پارامتر‌های دریافتی هر منبع: بر اساس زیربخش‌های مختلف کلاستر و نوع منبع متفاوت است:

|       منبع       | نود                                                                                                             | غیرنود                                                                          |
| :--------------: | --------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| پردازنده و حافظه | ظرفیت - میزان حد - میزان درخواست - مقدار استفاده شده - مقدار استفاده شده بیش از درخواست - مجموع استفاده فرزندان | میزان حد - میزان درخواست - مقدار استفاده شده - مقدار استفاده شده بیش از درخواست |
|       دیسک       | اختصاص داده شده - مجموع ظرفیت فرزندان - مقدار استفاده شده - ظرفیت - مقدار در دسترس                              | مقدار استفاده شده - ظرفیت - مقدار در دسترس                                      |

به عبارت دیگر هر پارامتر در منابع خاصی موجود است:

|                            | پردازنده و حافظه‌ی نودها | پردازنده و حافظه غیر نود | دیسک نودها | دیسک غیرنود | توضیحات                                                 |
| -------------------------- | ------------------------ | ------------------------ | ---------- | ----------- | ------------------------------------------------------- |
| ظرفیت capacity             | \*                       | \*                       | \*         |             |                                                         |
| حد limit                   | \*                       | \*                       |            |             | اگر صفر باشد یا مقدار نداشته باشد به معنای بی‌نهایت است |
| درخواست request            | \*                       | \*                       |            |             |                                                         |
| استفاده شده used           | \*                       | \*                       | \*         | \*          |                                                         |
| استفاده مازاد over request | \*                       | \*                       |            |             |                                                         |
| در دسترس available         |                          |                          | \*         | \*          |                                                         |
| اختصاص allocated           |                          |                          | \*         |             |                                                         |
| ظرفیت فرزندان child cap    |                          |                          | \*         |             |                                                         |
| استفاده فرزندان child used | \*                       |                          |            |             |                                                         |

تکه‌های نمودار : هر نمودار نمایش‌دهنده‌ی وضعیت منابع شامل بخش‌هایی با رنگ‌های مختلف است که در زیر نام، رنگ، برچسب و امکان وجود آنها در شرایط مختلف را می‌بینیم:

|                        | برچسب         | رنگ                 | پردازنده و حافظه نود | پردازنده و حافظه غیرنود | دیسک نود | دیسک غیرنود |
| ---------------------- | ------------- | ------------------- | -------------------- | ----------------------- | -------- | ----------- |
| استفاده بدون هیچ مشکلی | Ok            | سبز                 | \*                   | \*                      |          |             |
| استفاده مازاد          | Over Req      | نارنجی              | \*                   | \*                      |          |             |
| استفاده نادرست         | Over Lim      | قرمز                | \*                   | \*                      |          |             |
| استفاده نشده           | Not Used      | آبی                 | \*                   | \*                      | \*       |             |
| اختصاص نیافته          | Unallocated   | سفید                | \*                   |                         | \*       |             |
| دیگر                   | Other         | خاکستری             | \*                   |                         | \*       |             |
| استفاده                | Used          | سبز - نارنجی - قرمز |                      |                         | \*       | \*          |
| در دسترس               | Available     | سفید                |                      |                         |          | \*          |
| خارج از دسترسی         | Not Available | خاکستری             |                      |                         |          | \*          |

نشانگرهای نمودار : هر نمودار نمایش‌دهنده‌ی وضعیت منابع شامل یک یا چند نشانگر با رنگ و مقادیر مختلف است:

|                | پردازنده و حافظه | دیسک | توضیحات                                                            |
| -------------- | ---------------- | ---- | ------------------------------------------------------------------ |
| نشانگر درخواست | آبی              |      | در صورت برابر بودن مکان دو نشانگر تنها نشانگر حد نمایش داده می‌شود |
| نشانگر حد      | قرمز             |      | در صورت برابر بودن مکان دو نشانگر تنها نشانگر حد نمایش داده می‌شود |
| نشانگر ظرفیت   |                  | قرمز |                                                                    |

## صفحه رصد منابع

عملکرد اصلی صفحه: نمایش وضعیت منابع یک کلاستر

تنظیمات موجود :

- انتخاب کلاستر
- انتخاب نحوه‌ی نمایش در دو حالت پیش‌فرض و مقیاس شده
- جستجو (فیلتر) بر اساس نام زیربخش‌های یک کلاستر
- انتخاب دسته‌بندی منابع بر اساس نود یا فضانام

با انتخاب تنظیمات فوق به یک نمایش مشخص از وضعیت منابع خواهیم رسید. هر نمایش جدولی است که سطرهای آن ساختار درختی منابع و ستون‌های آن نوع منبع خواهد بود. در هر کدام از حالت‌های مختلف دسته‌بندی، ساختار درختی شامل موارد زیر است:

| ساختار درختی ستون نام            | نوع دسته‌بندی |
| -------------------------------- | ------------- |
| نود - پاد - کانتینر              | نود           |
| فضانام - ورک‌لود - پاد - کانتینر | فضانام        |

هر سلول این جدول نموداری است که نمایش‌دهنده‌ی وضعیت یک منبع مشخصِ مورد استفاده توسط یک زیربخش از کلاستر منتخب، از طریق پارامترهای دریافتی آن می‌باشد و با توجه به انتخاب نحوه‌ی نمایش معنای متفاوتی دارد.

### توضیح هر سلول جدول در نحوه‌ی نمایش پیش‌فرض:

در این نحوه‌ی نمایش تمامی نمودارهای موجود در سلول‌های مختلف طول یکسانی دارند. طول نمودار در زیربخش‌های مختلف کلاستر و بر اساس نوع منبع متفاوت است:

|                  | نود   | غیر نود                     |
| ---------------- | ----- | --------------------------- |
| پردازنده و حافظه | ظرفیت | ماکزیمم حد و (استفاده + کش) |
| دیسک             | ظرفیت | ظرفیت                       |

هر نمودار شامل چندین تکه و یک یا چند نشانگر است. مجموع طول تکه‌های مختلف برابر ۱۰۰ درصد طول نمودار بوده و طول هر تکه به شرح زیر می‌باشد:

| برچسب          | پردازنده و حافظه نود                                                       | پردازنده و حافظه غیر نود                                                   | دیسک نود                                                                                                                                                                          | دیسک غیر نود                                                                                                                                                                      |
| -------------- | -------------------------------------------------------------------------- | -------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Ok             | مینیمم حد و (استفاده منهای استفاده‌ی مازاد) (حد صفر به معنای بی‌نهایت است) | مینیمم حد و (استفاده منهای استفاده‌ی مازاد) (حد صفر به معنای بی‌نهایت است) |                                                                                                                                                                                   |                                                                                                                                                                                   |
| Over Req       | مینیمم استفاده‌ی مازاد و (حد منهای اوکی)                                   | مینیمم استفاده‌ی مازاد و (حد منهای اوکی)                                   |                                                                                                                                                                                   |                                                                                                                                                                                   |
| Over Lim       | استفاده منهای حد                                                           | استفاده منهای حد                                                           |                                                                                                                                                                                   |                                                                                                                                                                                   |
| Not Used       | حد منهای استفاده                                                           | حد منهای استفاده                                                           | (مینیمم ظرفیت نود و مجموع ظرفیت فرزندان) منهای اختصاص یافته                                                                                                                       |                                                                                                                                                                                   |
| Unallocated    | ظرفیت نود منهای حد                                                         |                                                                            | ظرفیت منهای ظرفیت فرزندان                                                                                                                                                         |                                                                                                                                                                                   |
| Other          | استفاده منهای استفاده فرزندان max(0, node_used - sum(child_used))          |                                                                            | اختصاص منهای استفاده                                                                                                                                                              |                                                                                                                                                                                   |
| Used           |                                                                            |                                                                            | استفاده (تنها تکه‌ای از نمودار که ممکن است رنگ‌های مختلفی داشته باشد. رنگ این تکه بر اساس مقدار آن اگر کمتر از ۸۵ درصد باشد سبز، اگر بین ۸۵ و ۹۵ باشد نارنجی و بالای ۹۵ قرمز است) | استفاده (تنها تکه‌ای از نمودار که ممکن است رنگ‌های مختلفی داشته باشد. رنگ این تکه بر اساس مقدار آن اگر کمتر از ۸۵ درصد باشد سبز، اگر بین ۸۵ و ۹۵ باشد نارنجی و بالای ۹۵ قرمز است) |
| Available      |                                                                            |                                                                            |                                                                                                                                                                                   | در دسترس                                                                                                                                                                          |
| Not Available  |                                                                            |                                                                            |                                                                                                                                                                                   | ظرفیت منهای (استفاده + در دسترس)                                                                                                                                                  |
| Over Allocated | max (0, other + sum(child_used) + sum(child_not_used) - capacity)          |                                                                            |                                                                                                                                                                                   |                                                                                                                                                                                   |

مکان هر نشانگر روی نمودار به طور دقیق برابر با نسبت مقدار آن مفهوم به طول نمودار است. در صورتی که مکان نشانگر از طول نمودار بیشتر باشد مکان اشاره شده‌ی آن متناسب با طول نمودار نیست و این موضوع در ظاهر نشانگر نیز در نظر گرفته شده است (خط چین به جای خط ممتد). مقادیر مورد اشاره‌ی نشانگر در پردازنده و حافظه برابر با پارامترهای دریافتی درخواست و حد بوده که در نود و غیر آن یکسان است. اما در دیسک مقدار مورد اشاره متفاوت است:

|         | پردازنده و حافظه | دیسک                |
| ------- | ---------------- | ------------------- |
| نود     | درخواست و حد     | مجموع ظرفیت فرزندان |
| غیر نود | درخواست و حد     | ظرفیت               |

### توضیح هر سلول جدول در نحوه‌ی نمایش مقیاس‌شده :

در این نحوه‌ی نمایش تمامی مقادیر اعم از طول تکه‌های نمودار و مکان مورد اشاره‌ی نشانگرها روی نمودار بر اساس یک بیشینه مختص به آن ستون (نوع منبع) مقیاس می‌شوند. در واقع تمامی این مقادیر در ۱۰۰ ضرب شده و بر بیشینه‌ی مورد نظر تقسیم می‌شوند تا نسبت آن مقدار به حداکثر طول نمودار (به صورت درصدی) به دست آید. نحوه‌ی به دست آوردن بیشینه برای هر ستون به این شرح است:

|                              | فرمول                                                               | توضیح                                                                                                                                                                                                                                               |
| ---------------------------- | ------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| پردازنده و حافظه (نیم‌اسپیس) | max(max(request, used), min(max(request, used) \* 1.2, max(limit))) | ابتدا بین درخواست و استفاده‌ی تمامی منابع آن ستون ماکزیمم گرفته میشود (بیشترین درخواست یا استفاده). این عدد در ۱.۲ ضرب شده و بین آن و بیشترین حد آن ستون مینیمم میگیریم. سپس حاصل این مینیمم را با همان بیشترین درخواست یا استفاده ماکزیمم میگیریم. |
| پردازنده و حافظه (نود)       | max(capacity)                                                       | ماکزیمم ظرفیت منابع آن ستون                                                                                                                                                                                                                         |
| دیسک                         | max(capacity)                                                       | ماکزیمم ظرفیت دیسک‌های آن ستون (ssd یا hdd)                                                                                                                                                                                                         |

تفاوت دیگر این نحوه‌ی نمایش با نحوه‌ی نمایش پیش‌فرض آن است که در اینجا ممکن است بعضی از تکه‌های نمودار فشرده شوند. به این معنی که به علت انتخاب بیشینه گاهی مجموع طول تکه‌های نمودار از ۱۰۰ درصد حداکثر طول مجاز نمودار بیشتر میشود، بنابراین بعضی تکه‌ها را کمتر از نسبت واقعی آن‌ها نمایش میدهیم. این تغییر در شیوه‌ی نمایش این تکه‌ها نیز منعکس شده و این تکه‌ها به صورت منقطع درمیایند. در مورد نشانگرها تا زمانی که مقادیر آنها از بیشینه بیشتر نباشد مکان مورد اشاره آنها دقیق است و در صورتی که از بیشینه بیشتر شوند شبیه همان چیزی که در نحوه‌ی نمایش پیش‌فرض گفته شد ارائه میشوند.

#### قانون فشرده‌سازی تکه‌های نمودار به این شرح است:

اگر مجموع طول تکه‌های نمودار کمتر مساوی ۱۰۰ شود (یعنی مجموع مقادیر کمتر مساوی بیشینه باشد) هیچ فشرده‌سازی اتفاق نمی‌افتد. اگر این مجموع بیشتر باشد از انتهای نمودار شروع کرده و یکی یکی تکه‌های نمودار را حذف می‌کنیم تا جایی که مجموع تکه‌های باقی‌مانده کمتر از ۱۰۰ شود. از بین این تکه‌های آخر نمودار به ترتیب از کوچکترین آن‌ها شروع به اضافه کردن به نمودار می‌کنیم تا جایی که مجموع از ۱۰۰ درصد بیشتر نشود، تکه‌هایی که باقی می‌مانند باید فشرده شوند. حال طول لازم برای پر کردن نمودار تا ۱۰۰ را بر تعداد تکه‌های حذف شده تقسیم می‌کنیم و به همه تکه‌های حذف شده طولی برابر می‌دهیم و با تغییر شیوه نمایش، فشرده‌شدن (دقیق نبودن نسبت اندازه) آن‌ها را مشخص می‌کنیم.
